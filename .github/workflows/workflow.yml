name: Build and Deploy Code Compass

on:
  push:
    branches: [ "main" ]

env:
  IMAGE_NAME: next-code-compass

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # Checkout repo
      - name: Checkout Code
        uses: actions/checkout@v3

      # Create commit SHA tag
      - name: Set TAG
        run: echo "TAG=${GITHUB_SHA::8}" >> $GITHUB_ENV

      - name: Show TAG value
        run: echo "Using TAG ${{ env.TAG }}"

      # Login to Docker Hub
      - name: Login to Docker Registry
        run: echo "${{ secrets.PASSWORD }}" | docker login -u ${{ secrets.USERNAME }} --password-stdin

      # Build and tag image with SHA and latest (use Buildx with auth secrets as build args)
      - name: Build Docker Image
        run: docker buildx build --load \
          --secret id=oidc_client_id,src=${{ secrets.OIDC_CLIENT_ID }} \
          --secret id=oidc_client_secret,src=${{ secrets.OIDC_CLIENT_SECRET }} \
          --secret id=oidc_issuer,src=${{ secrets.OIDC_ISSUER }} \
          --secret id=nextauth_secret,src=${{ secrets.NEXTAUTH_SECRET }} \
          --build-arg NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }} \
          -t ${{ secrets.USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.TAG }} \
          -t ${{ secrets.USERNAME }}/${{ env.IMAGE_NAME }}:latest \
          .

      # Push both tags
      - name: Push Docker Image
        run: |
          docker push ${{ secrets.USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.TAG }}
          docker push ${{ secrets.USERNAME }}/${{ env.IMAGE_NAME }}:latest

      - name: Logout from Docker Registry
        if: always()
        run: docker logout

      # Deploy to server via SSH
      - name: Deploy on Server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            export DOCKER_USERNAME=${{ secrets.USERNAME }}
            export NEXT_PUBLIC_BASE_URL_CODE_COMPASS=${{ secrets.NEXT_PUBLIC_BASE_URL_CODE_COMPASS }}
            export BASE_URL_CODE_COMPASS=${{ secrets.BASE_URL_CODE_COMPASS }}
            export OIDC_CLIENT_ID=${{ secrets.OIDC_CLIENT_ID }}
            export OIDC_CLIENT_SECRET=${{ secrets.OIDC_CLIENT_SECRET }}
            export OIDC_ISSUER=${{ secrets.OIDC_ISSUER }}
            export NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            export NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            export CCP_GITHUB_CLIENT_ID=${{ secrets.CCP_GITHUB_CLIENT_ID }}
            export CCP_GITHUB_CLIENT_SECRET=${{ secrets.CCP_GITHUB_CLIENT_SECRET }}
            export GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            export GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            
            cd front/
            docker compose down
            docker pull $DOCKER_USERNAME/next-code-compass:latest
            docker compose up -d --force-recreate --remove-orphans